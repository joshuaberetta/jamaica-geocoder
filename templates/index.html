<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jamaica Address Geocoder</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f4f5f7;
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 16px 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-direction: column;
        }
        
        .logo-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-placeholder {
            width: 120px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-placeholder svg {
            width: 100%;
            height: auto;
        }
        
        .tagline {
            color: #95a5a6;
            font-size: 10px;
            font-weight: 400;
            font-style: italic;
            letter-spacing: 0.3px;
        }
        
        .container {
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            padding: 32px 40px;
            margin: 0 auto;
        }
        
        h2 {
            color: #2c3e50;
            margin-bottom: 16px;
            font-size: 18px;
            font-weight: 500;
        }
        
        .single-address-section {
            margin-bottom: 32px;
            padding: 24px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e1e4e8;
        }
        
        .address-input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .address-input-group input[type="text"] {
            flex: 1;
            padding: 11px 12px;
            border: 1px solid #d1d5da;
            border-radius: 3px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .address-input-group input[type="text"]:focus {
            outline: none;
            border-color: #4A90E2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }
        
        .address-input-group button {
            width: auto;
            padding: 11px 24px;
            white-space: nowrap;
        }
        
        .single-result {
            display: none;
            padding: 16px;
            border-radius: 3px;
            font-size: 14px;
        }
        
        .single-result.success {
            display: block;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .single-result.error {
            display: block;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .single-result .result-row {
            margin: 6px 0;
        }
        
        .single-result .result-label {
            font-weight: 600;
            display: inline-block;
            min-width: 150px;
        }
        
        .divider {
            text-align: center;
            margin: 32px 0;
            position: relative;
        }
        
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e1e4e8;
        }
        
        .divider span {
            background: white;
            padding: 0 16px;
            color: #7f8c8d;
            font-size: 13px;
            position: relative;
            z-index: 1;
        }
        
        .login-prompt {
            padding: 48px;
            text-align: center;
            background: #f8f9fa;
            border: 2px dashed #d1d5da;
            border-radius: 4px;
            color: #586069;
        }
        
        .login-prompt h3 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .login-prompt p {
            margin-bottom: 24px;
            font-size: 14px;
        }
        
        .login-prompt .btn-login {
            display: inline-block;
            padding: 12px 32px;
            background: #4A90E2;
            color: white;
            text-decoration: none;
            border-radius: 3px;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .login-prompt .btn-login:hover {
            background: #357ABD;
        }
        
        .logout-btn {
            padding: 8px 16px;
            background: white;
            color: #4A90E2;
            text-decoration: none;
            border: 1px solid #d1d5da;
            border-radius: 3px;
            font-size: 13px;
            transition: background-color 0.2s, border-color 0.2s;
            font-weight: 500;
        }
        
        .logout-btn:hover {
            background: #f6f8fa;
            border-color: #4A90E2;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 24px;
            font-weight: 500;
        }
        
        .subtitle {
            color: #7f8c8d;
            margin-bottom: 32px;
            font-size: 14px;
            font-weight: 400;
        }
        
        .upload-area {
            border: 2px dashed #d1d5da;
            border-radius: 4px;
            padding: 48px;
            text-align: center;
            background: #fafbfc;
            margin-bottom: 24px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #4A90E2;
            background: #f6f8fa;
        }
        
        .upload-area.dragover {
            background: #e6f3ff;
            border-color: #4A90E2;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.6;
        }
        
        .upload-area p {
            color: #586069;
            font-size: 14px;
            margin: 4px 0;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-name {
            margin-top: 16px;
            color: #4A90E2;
            font-weight: 500;
            font-size: 14px;
        }
        
        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .option-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-size: 13px;
            color: #2c3e50;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        select, input[type="number"] {
            padding: 11px 12px;
            border: 1px solid #d1d5da;
            border-radius: 3px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: #4A90E2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }
        
        button {
            width: 100%;
            padding: 12px 16px;
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 3px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            font-family: inherit;
        }
        
        button:hover:not(:disabled) {
            background: #357ABD;
        }
        
        button:active:not(:disabled) {
            background: #2E6DA4;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .progress {
            display: none;
            margin-top: 24px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e1e4e8;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #4A90E2;
            animation: indeterminate 1.5s infinite;
        }
        
        @keyframes indeterminate {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(400%); }
        }
        
        .status {
            margin-top: 12px;
            text-align: center;
            color: #586069;
            font-size: 13px;
        }
        
        .error {
            margin-top: 24px;
            padding: 12px 16px;
            background: #fff5f5;
            border: 1px solid #feb2b2;
            border-radius: 3px;
            color: #c53030;
            font-size: 13px;
            display: none;
        }
        
        .success-summary {
            margin-top: 24px;
            padding: 24px;
            background: #f0f9ff;
            border: 1px solid #4A90E2;
            border-radius: 4px;
            display: none;
        }
        
        .success-summary h3 {
            color: #2c3e50;
            margin-bottom: 16px;
            font-size: 16px;
            font-weight: 500;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .stat-box {
            background: white;
            padding: 16px;
            border: 1px solid #e1e4e8;
            border-radius: 3px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .stat-number.total { color: #4A90E2; }
        .stat-number.success { color: #28a745; }
        .stat-number.failed { color: #ffa726; }
        .stat-number.skipped { color: #9e9e9e; }
        
        .stat-label {
            font-size: 11px;
            color: #586069;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        
        .download-again {
            margin-top: 16px;
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }
        
        .download-again:hover {
            background: #218838;
        }
        
        .info-box {
            margin-top: 32px;
            padding: 20px;
            background: #fafbfc;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            font-size: 13px;
            color: #586069;
        }
        
        .info-box h3 {
            margin-bottom: 12px;
            color: #2c3e50;
            font-size: 14px;
            font-weight: 500;
        }
        
        .info-box ul {
            margin-left: 20px;
        }
        
        .info-box li {
            margin-bottom: 6px;
        }
        
        .info-box code {
            background: #fff;
            border: 1px solid #e1e4e8;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }
        
        .footer {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #e8e8e8;
            text-align: center;
            color: #7f8c8d;
            font-size: 12px;
        }
        
        .footer a {
            color: #4A90E2;
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        .kobo-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            vertical-align: middle;
            margin-right: 4px;
        }
        
        .kobo-icon svg {
            width: 100%;
            height: 100%;
        }
        
        .map-section {
            margin-bottom: 32px;
            padding: 24px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e1e4e8;
        }
        
        #map {
            height: 400px;
            width: 100%;
            border-radius: 4px;
            border: 1px solid #d1d5da;
            margin-top: 12px;
        }
        
        .map-result {
            display: none;
            margin-top: 16px;
            padding: 16px;
            border-radius: 3px;
            font-size: 14px;
        }
        
        .map-result.success {
            display: block;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .map-result.error {
            display: block;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .map-result .result-row {
            margin: 6px 0;
        }
        
        .map-result .result-label {
            font-weight: 600;
            display: inline-block;
            min-width: 150px;
        }
        
        .map-instructions {
            color: #586069;
            font-size: 13px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-container">
            <div class="logo-row">
                <div class="logo-placeholder">
                    <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 1141.27 394.59" style="enable-background:new 0 0 1141.27 394.59;" xml:space="preserve">
                        <g>
                            <path style="fill:#06415B;" d="M424.66,107.97c-67.95,0-120.8,54.74-120.8,120.8s54.74,120.8,120.8,120.8s120.8-54.74,120.8-120.8 C547.35,160.82,492.61,107.97,424.66,107.97z M424.66,302.38c-39.64,0-71.73-32.09-71.73-71.73s32.09-71.73,71.73-71.73 s71.73,32.09,71.73,71.73C498.28,268.41,464.3,302.38,424.66,302.38z"/>
                            <path style="fill:#06415B;" d="M707.8,107.97c-33.98-5.66-66.06,3.78-90.6,22.65V68.33c0-18.88-15.1-32.09-32.09-32.09l0,0 c-9.44,0-15.1,7.55-15.1,15.1V315.6c0,18.88,15.1,32.09,32.09,32.09l0,0c9.44,0,15.1-7.55,15.1-15.1v-5.66 c20.76,15.1,45.3,24.54,71.73,24.54c71.73,0,128.35-62.29,120.8-135.9C804.06,160.82,760.65,117.4,707.8,107.97z M673.82,300.5 c-33.98-7.55-56.63-39.64-56.63-73.62l0,0c0-26.43,13.21-49.08,35.86-60.4c54.74-26.43,107.59,13.21,107.59,64.18 C762.54,274.07,721.01,309.94,673.82,300.5z"/>
                            <path style="fill:#06415B;" d="M951.29,107.97c-67.95,0-120.8,54.74-120.8,120.8s54.74,120.8,120.8,120.8s120.8-54.74,120.8-120.8 C1073.98,160.82,1019.24,107.97,951.29,107.97z M951.29,302.38c-39.64,0-71.73-32.09-71.73-71.73s32.09-71.73,71.73-71.73 c39.64,0,71.73,32.09,71.73,71.73C1024.91,268.41,990.93,302.38,951.29,302.38z"/>
                            <path style="fill:#06415B;" d="M322.73,330.7L188.71,196.68L300.08,85.31c5.66-5.66,1.89-15.1-5.66-15.1h-20.76 c-16.99,0-33.98,7.55-45.3,18.88L128.31,189.13V102.3c0-18.88-15.1-32.09-32.09-32.09l0,0c-7.55,0-15.1,7.55-15.1,15.1V315.6 c0,18.88,15.1,32.09,32.09,32.09l0,0c7.55,0,15.1-7.55,15.1-15.1v-49.08c0-15.1,5.66-28.31,15.1-37.75l13.21-13.21L251,326.92 c11.33,11.33,28.31,18.88,45.3,18.88h20.76C324.62,345.8,328.39,336.36,322.73,330.7z"/>
                        </g>
                    </svg>
                </div>
                <span style="color: #7f8c8d; font-size: 14px;">Jamaica Address Geocoder</span>
            </div>
            <p class="tagline">Where data meets purpose</p>
        </div>
        {% if logged_in %}
        <a href="/logout" class="logout-btn">Sign Out</a>
        {% else %}
        <a href="/login" class="logout-btn">Sign In</a>
        {% endif %}
    </div>
    
    <div class="container">
        <h1>Jamaica Address Geocoder</h1>
        <p class="subtitle">Enter a single address or upload a CSV file with addresses to geocode and match to administrative boundaries</p>
        
        <!-- Single Address Input Section -->
        <div class="single-address-section">
            <h2>Single Address Lookup</h2>
            <div class="address-input-group">
                <input type="text" id="singleAddress" placeholder="Enter address or GPS coordinates (e.g., '18.0179, -76.8099' or '123 Main St, Kingston')">
                <button type="button" id="geocodeSingleBtn">Geocode</button>
            </div>
            <div class="single-result" id="singleResult"></div>
        </div>
        
        <div class="divider">
            <span>OR</span>
        </div>
        
        <!-- Map Point Selection Section -->
        <div class="map-section">
            <h2>Select Point from Map</h2>
            <p class="map-instructions">Click anywhere on the map to get P-code information for that location</p>
            <div id="map"></div>
            <div class="map-result" id="mapResult"></div>
        </div>
        
        <div class="divider">
            <span>OR</span>
        </div>
        
        <h2>Batch File Upload</h2>
        {% if logged_in %}
        <form id="uploadForm" enctype="multipart/form-data">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÑ</div>
                <p>Click to upload or drag and drop</p>
                <p style="font-size: 12px; color: #999; margin-top: 5px;">CSV or Excel file (.csv, .xlsx, .xls)</p>
                <input type="file" id="fileInput" name="file" accept=".csv,.xlsx,.xls">
                <div class="file-name" id="fileName"></div>
            </div>
            
            <div class="options">
                <div class="option-group">
                    <label for="format">Output Format</label>
                    <select id="format" name="format">
                        <option value="csv">CSV</option>
                        <option value="xlsx" selected>Excel (XLSX)</option>
                    </select>
                </div>
                
                <div class="option-group">
                    <label for="limit">Limit (optional)</label>
                    <input type="number" id="limit" name="limit" placeholder="All addresses" min="1">
                </div>
            </div>
            
            <button type="submit" id="submitBtn">Geocode Addresses</button>
        </form>
        
        <div class="progress" id="progress">
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
            <div class="status" id="status">Processing addresses...</div>
        </div>
        
        <div class="error" id="error"></div>
        
        <div class="success-summary" id="successSummary">
            <h3>‚úÖ Geocoding Complete!</h3>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-number total" id="statTotal">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number success" id="statSuccess">0</div>
                    <div class="stat-label">Successful</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number failed" id="statFailed">0</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number skipped" id="statSkipped">0</div>
                    <div class="stat-label">Skipped</div>
                </div>
            </div>
            <p style="margin-bottom: 10px; color: #555; font-size: 14px;">Your file has been downloaded automatically.</p>
            <button class="download-again" id="downloadAgain">Download Again</button>
        </div>
        
        <div class="info-box">
            <h3>üìã File Format Requirements</h3>
            <ul>
                <li>Accepts CSV (semicolon-separated) or Excel (.xlsx, .xls)</li>
                <li>Required columns: <code>address</code></li>
                <li>Optional columns: <code>date</code>, <code>name</code>, <code>hot_meals</code></li>
                <li>Date format: <code>m/d</code> (will be converted to yyyy-mm-dd)</li>
                <li>UTF-8 encoding for CSV files</li>
            </ul>
        </div>
        {% else %}
        <div class="login-prompt">
            <h3>üîê Sign In Required</h3>
            <p>Batch file processing requires authentication. Please sign in to upload and geocode multiple addresses.</p>
            <a href="/login" class="btn-login">Sign In for Batch Processing</a>
        </div>
        {% endif %}
        
        <div class="footer">
            <span class="kobo-icon">
                <svg viewBox="0 0 107 159" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M86.1382 106.78V122.26C86.1146 126.382 84.4666 130.329 81.5517 133.244C78.6369 136.159 74.6903 137.807 70.5682 137.83H36.9082C32.7861 137.807 28.8395 136.159 25.9247 133.244C23.0098 130.329 21.3618 126.382 21.3382 122.26V36.0401C21.3618 31.918 23.0098 27.9714 25.9247 25.0566C28.8395 22.1417 32.7861 20.4937 36.9082 20.4701H70.5682C74.6903 20.4937 78.6369 22.1417 81.5517 25.0566C84.4666 27.9714 86.1146 31.918 86.1382 36.0401V38.1101C89.0551 37.2073 92.0852 36.7224 95.1382 36.6701C98.8944 36.6783 102.617 37.3801 106.118 38.7401V36.0401C106.118 26.4923 102.325 17.3356 95.574 10.5843C88.8227 3.83298 79.666 0.0401306 70.1182 0.0401306H36.9082C27.3604 0.0401306 18.2037 3.83298 11.4524 10.5843C4.70105 17.3356 0.908203 26.4923 0.908203 36.0401V122.26C0.908203 131.808 4.70105 140.965 11.4524 147.716C18.2037 154.467 27.3604 158.26 36.9082 158.26H70.5682C80.116 158.26 89.2727 154.467 96.0241 147.716C102.775 140.965 106.568 131.808 106.568 122.26V83.2901L86.1382 106.78Z" fill="#2095F3"/>
                    <path d="M69.6682 102.01L105.668 60.3401C106.24 59.7666 106.561 58.9898 106.561 58.1801C106.561 57.3704 106.24 56.5937 105.668 56.0201V56.0201C104.148 54.687 102.379 53.6685 100.462 53.0234C98.5462 52.3782 96.5211 52.1193 94.5041 52.2616C92.4872 52.4039 90.5185 52.9445 88.7118 53.8522C86.9051 54.76 85.2963 56.0168 83.9782 57.5501L61.6582 83.2901C61.54 83.4242 61.3946 83.5316 61.2316 83.6051C61.0687 83.6787 60.892 83.7167 60.7132 83.7167C60.5345 83.7167 60.3578 83.6787 60.1948 83.6051C60.0319 83.5316 59.8865 83.4242 59.7682 83.2901L51.3982 73.0301C50.9928 72.5704 50.4943 72.2023 49.9356 71.9501C49.377 71.6979 48.7711 71.5675 48.1582 71.5675C47.5453 71.5675 46.9394 71.6979 46.3808 71.9501C45.8222 72.2023 45.3236 72.5704 44.9182 73.0301C42.3473 75.7498 40.8487 79.3087 40.6998 83.0482C40.5508 86.7878 41.7617 90.4546 44.1082 93.3701L50.9482 101.83C52.084 103.205 53.5064 104.315 55.116 105.082C56.7255 105.85 58.4833 106.256 60.2664 106.273C62.0494 106.29 63.8147 105.918 65.4387 105.181C67.0627 104.445 68.5062 103.363 69.6682 102.01V102.01Z" fill="#2095F3"/>
                </svg>
            </span>
            Built by <a href="https://www.kobo.ngo/" target="_blank">Kobo</a>
        </div>
    </div>
    
    <script>
        // Initialize map
        const map = L.map('map').setView([18.1096, -77.2975], 9); // Center on Jamaica
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Load and display community boundaries
        console.log('Fetching boundaries...');
        fetch('/boundaries.geojson')
            .then(response => {
                console.log('Boundaries response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Boundaries data loaded:', data.type, 'Features:', data.features?.length);
                const boundaryLayer = L.geoJSON(data, {
                    style: {
                        color: '#4A90E2',
                        weight: 2,
                        opacity: 0.6,
                        fillOpacity: 0.1
                    },
                    onEachFeature: function(feature, layer) {
                        if (feature.properties) {
                            const props = feature.properties;
                            layer.bindTooltip(
                                `<strong>${props.ADM2_EN || 'Unknown'}</strong><br>` +
                                `${props.ADM1_EN || 'Unknown Parish'}<br>` +
                                `<small>P-Code: ${props.ADM2_PCODE || 'N/A'}</small>`,
                                { sticky: true }
                            );
                        }
                    }
                }).addTo(map);
                console.log('Boundaries added to map');
            })
            .catch(error => {
                console.error('Error loading boundaries:', error);
            });
        
        // Add a marker that will be placed on click
        let currentMarker = null;
        const mapResult = document.getElementById('mapResult');
        
        // Handle map clicks
        map.on('click', async function(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            
            // Remove previous marker if exists
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }
            
            // Add new marker
            currentMarker = L.marker([lat, lon]).addTo(map);
            
            // Show loading state
            showMapResult('Loading P-code information...', null);
            
            try {
                const response = await fetch('/reverse_geocode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ latitude: lat, longitude: lon })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMapResult(`
                        <div class="result-row"><span class="result-label">Latitude:</span> ${result.latitude.toFixed(6)}</div>
                        <div class="result-row"><span class="result-label">Longitude:</span> ${result.longitude.toFixed(6)}</div>
                        <div class="result-row"><span class="result-label">Parish (P-Code):</span> ${result.parish_pcode || 'N/A'}</div>
                        <div class="result-row"><span class="result-label">Parish Name:</span> ${result.parish_name || 'N/A'}</div>
                        <div class="result-row"><span class="result-label">Community (P-Code):</span> ${result.community_pcode || 'N/A'}</div>
                        <div class="result-row"><span class="result-label">Community Name:</span> ${result.community_name || 'N/A'}</div>
                    `, true);
                    
                    // Update marker popup
                    currentMarker.bindPopup(`
                        <strong>${result.parish_name || 'Unknown Parish'}</strong><br>
                        ${result.community_name || 'Unknown Community'}<br>
                        <small>P-Code: ${result.community_pcode || 'N/A'}</small>
                    `).openPopup();
                } else {
                    showMapResult(result.error || 'Could not find P-code information for this location', false);
                }
            } catch (error) {
                showMapResult('Error: ' + error.message, false);
            }
        });
        
        function showMapResult(html, success) {
            mapResult.innerHTML = html;
            if (success === null) {
                // Loading state
                mapResult.className = 'map-result';
                mapResult.style.display = 'block';
                mapResult.style.background = '#f8f9fa';
                mapResult.style.border = '1px solid #e1e4e8';
                mapResult.style.color = '#586069';
            } else {
                mapResult.className = 'map-result ' + (success ? 'success' : 'error');
                mapResult.style.display = 'block';
            }
        }
        
        // Single address elements (always available)
        const singleAddressInput = document.getElementById('singleAddress');
        const geocodeSingleBtn = document.getElementById('geocodeSingleBtn');
        const singleResult = document.getElementById('singleResult');
        
        // Batch upload elements (only if logged in)
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const uploadForm = document.getElementById('uploadForm');
        const submitBtn = document.getElementById('submitBtn');
        const progress = document.getElementById('progress');
        const status = document.getElementById('status');
        const errorDiv = document.getElementById('error');
        const successSummary = document.getElementById('successSummary');
        const downloadAgainBtn = document.getElementById('downloadAgain');
        
        let lastDownloadData = null;
        
        // Single address geocoding
        geocodeSingleBtn.addEventListener('click', async () => {
            const address = singleAddressInput.value.trim();
            
            if (!address) {
                showSingleResult('Please enter an address or GPS coordinates', false);
                return;
            }
            
            geocodeSingleBtn.disabled = true;
            geocodeSingleBtn.textContent = 'Geocoding...';
            singleResult.style.display = 'none';
            
            try {
                const response = await fetch('/geocode_single', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ address: address })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSingleResult(`
                        <div class="result-row"><span class="result-label">Address:</span> ${result.address}</div>
                        <div class="result-row"><span class="result-label">Latitude:</span> ${result.latitude.toFixed(6)}</div>
                        <div class="result-row"><span class="result-label">Longitude:</span> ${result.longitude.toFixed(6)}</div>
                        <div class="result-row"><span class="result-label">Confidence:</span> ${result.confidence}</div>
                        <div class="result-row"><span class="result-label">Parish (P-Code):</span> ${result.parish_pcode || 'N/A'}</div>
                        <div class="result-row"><span class="result-label">Parish Name:</span> ${result.parish_name || 'N/A'}</div>
                        <div class="result-row"><span class="result-label">Community (P-Code):</span> ${result.community_pcode || 'N/A'}</div>
                        <div class="result-row"><span class="result-label">Community Name:</span> ${result.community_name || 'N/A'}</div>
                    `, true);

                    // Add marker to map and center on the location
                    const lat = result.latitude;
                    const lon = result.longitude;

                    // Remove previous marker if exists
                    if (currentMarker) {
                        map.removeLayer(currentMarker);
                    }

                    // Add new marker at the geocoded location
                    currentMarker = L.marker([lat, lon]).addTo(map);

                    // Add popup to the marker with location details
                    currentMarker.bindPopup(`
                        <strong>${result.parish_name || 'Unknown Parish'}</strong><br>
                        ${result.community_name || 'Unknown Community'}<br>
                        <small>P-Code: ${result.community_pcode || 'N/A'}</small><br>
                        <small>${result.address}</small>
                    `).openPopup();

                    // Center and zoom the map to show the marker
                    map.setView([lat, lon], 14);

                    // Update the map result display
                    showMapResult(`
                        <div class="result-row"><span class="result-label">Latitude:</span> ${lat.toFixed(6)}</div>
                        <div class="result-row"><span class="result-label">Longitude:</span> ${lon.toFixed(6)}</div>
                        <div class="result-row"><span class="result-label">Parish (P-Code):</span> ${result.parish_pcode || 'N/A'}</div>
                        <div class="result-row"><span class="result-label">Parish Name:</span> ${result.parish_name || 'N/A'}</div>
                        <div class="result-row"><span class="result-label">Community (P-Code):</span> ${result.community_pcode || 'N/A'}</div>
                        <div class="result-row"><span class="result-label">Community Name:</span> ${result.community_name || 'N/A'}</div>
                    `, true);
                } else {
                    showSingleResult(result.error || 'Failed to geocode address', false);
                }
            } catch (error) {
                showSingleResult('Error: ' + error.message, false);
            } finally {
                geocodeSingleBtn.disabled = false;
                geocodeSingleBtn.textContent = 'Geocode';
            }
        });
        
        // Allow Enter key to trigger geocoding
        singleAddressInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                geocodeSingleBtn.click();
            }
        });
        
        function showSingleResult(html, success) {
            singleResult.innerHTML = html;
            singleResult.className = 'single-result ' + (success ? 'success' : 'error');
            singleResult.style.display = 'block';
        }
        
        // Batch upload functionality (only if elements exist - user is logged in)
        if (uploadArea && fileInput && uploadForm) {
            // Click to upload
            uploadArea.addEventListener('click', () => fileInput.click());
        
        // File selection
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                fileName.textContent = `üìé ${e.target.files[0].name}`;
                // Hide success summary when new file is selected
                successSummary.style.display = 'none';
            }
        });
        
        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                fileName.textContent = `üìé ${e.dataTransfer.files[0].name}`;
                successSummary.style.display = 'none';
            }
        });
        
        // Download again button
        downloadAgainBtn.addEventListener('click', () => {
            if (lastDownloadData) {
                downloadFile(lastDownloadData.fileData, lastDownloadData.filename, lastDownloadData.mimetype);
            }
        });
        
        // Form submission
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!fileInput.files.length) {
                showError('Please select a file to upload');
                return;
            }
            
            const formData = new FormData(uploadForm);
            
            // Show progress
            progress.style.display = 'block';
            errorDiv.style.display = 'none';
            successSummary.style.display = 'none';
            submitBtn.disabled = true;
            status.textContent = 'Uploading and geocoding addresses...';
            
            try {
                const response = await fetch('/geocode', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to geocode addresses');
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to geocode addresses');
                }
                
                // Store download data
                lastDownloadData = {
                    fileData: result.file_data,
                    filename: result.filename,
                    mimetype: result.mimetype
                };
                
                // Download the file
                downloadFile(result.file_data, result.filename, result.mimetype);
                
                // Display statistics
                displayStats(result.stats);
                
                progress.style.display = 'none';
                submitBtn.disabled = false;
                
            } catch (error) {
                showError(error.message);
                progress.style.display = 'none';
                submitBtn.disabled = false;
            }
        });
        
        function downloadFile(base64Data, filename, mimetype) {
            // Convert base64 to blob
            const byteCharacters = atob(base64Data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: mimetype });
            
            // Create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function displayStats(stats) {
            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statSuccess').textContent = stats.successful;
            document.getElementById('statFailed').textContent = stats.failed;
            document.getElementById('statSkipped').textContent = stats.skipped;
            successSummary.style.display = 'block';
        }
        
        function showError(message) {
            errorDiv.textContent = `‚ùå ${message}`;
            errorDiv.style.display = 'block';
        }
        } // End of batch upload functionality
    </script>
</body>
</html>
